name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  release-readiness:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    env:
      LIVE_MATRIX_REQUIRED: ${{ vars.LIVE_MATRIX_REQUIRED }}
      LIVE_MATRIX_MAX_AGE_DAYS: ${{ vars.LIVE_MATRIX_MAX_AGE_DAYS }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Check release-readiness live matrix signal
        run: |
          if [ "${LIVE_MATRIX_REQUIRED}" != "1" ]; then
            echo "LIVE_MATRIX_REQUIRED is not enabled; skipping live-matrix release gate."
            exit 0
          fi

          if [ -z "${LIVE_MATRIX_MAX_AGE_DAYS}" ]; then
            LIVE_MATRIX_MAX_AGE_DAYS=14
          fi

          api_url="https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/live-matrix.yml/runs?branch=main&status=completed&per_page=20"
          json="$(curl -fsSL -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "${api_url}")"

          latest_success="$(echo "${json}" | jq -r '.workflow_runs[] | select(.conclusion=="success") | .run_started_at' | head -n 1)"
          if [ -z "${latest_success}" ] || [ "${latest_success}" = "null" ]; then
            echo "::error::No successful live-matrix.yml run found on main."
            exit 1
          fi

          python - <<'PY' "${latest_success}" "${LIVE_MATRIX_MAX_AGE_DAYS}"
          import datetime
          import sys

          latest = datetime.datetime.fromisoformat(sys.argv[1].replace("Z", "+00:00"))
          max_age_days = int(sys.argv[2])
          now = datetime.datetime.now(datetime.timezone.utc)
          age_days = (now - latest).days
          if age_days > max_age_days:
              print(f"::error::Latest successful live matrix run is {age_days} days old (limit {max_age_days}).")
              raise SystemExit(1)
          print(f"Live matrix freshness check passed ({age_days} days old, limit {max_age_days}).")
          PY

  goreleaser:
    needs:
      - release-readiness
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: vscode-extension/package-lock.json

      - name: Validate test suite
        run: |
          go test ./... -count=1
          go vet ./...

      - name: Validate extension suite
        working-directory: vscode-extension
        run: |
          npm ci
          npm run lint
          npm run test
          npm run build
          npm run package:vsix

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate release artifact metadata
        run: |
          set -euo pipefail

          if [ ! -s dist/checksums.txt ]; then
            echo "::error::dist/checksums.txt missing or empty."
            exit 1
          fi

          template="docs/releases/release-notes-template.md"
          if [ ! -f "${template}" ]; then
            echo "::error::${template} missing."
            exit 1
          fi

          if ! grep -qi "installation" "${template}"; then
            echo "::error::${template} must include installation section."
            exit 1
          fi

          if ! grep -qi "checksums" "${template}"; then
            echo "::error::${template} must include checksums section."
            exit 1
          fi

          if ! grep -Eqi '\[[^]]*install[^]]*\]\([^)]+\)' "${template}"; then
            echo "::error::${template} must include an install instructions link."
            exit 1
          fi

      - name: Attach VSIX to GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: vscode-extension/*.vsix
          fail_on_unmatched_files: true
