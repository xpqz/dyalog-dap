name: ci

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  critical-gate:
    name: critical-gate (go ${{ matrix.go-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        go-version: ["1.22.x", "1.23.x"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      - name: Run critical protocol/adapter suites
        run: |
          go test ./internal/ride/protocol ./internal/ride/sessionstate ./internal/dap/adapter ./internal/integration/harness -count=1

  extension-package:
    name: extension-package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: vscode-extension/package-lock.json
      - name: Install extension dependencies
        working-directory: vscode-extension
        run: npm ci
      - name: Lint extension
        working-directory: vscode-extension
        run: npm run lint
      - name: Contract test extension
        working-directory: vscode-extension
        run: npm run test:contracts
      - name: Test extension
        working-directory: vscode-extension
        run: npm run test
      - name: Build extension
        working-directory: vscode-extension
        run: npm run build

  full-suite:
    name: full-suite
    runs-on: ubuntu-latest
    needs:
      - critical-gate
      - extension-package
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"
      - name: Run full test suite
        run: go test ./... -count=1
      - name: Run vet
        run: go vet ./...

  live-dyalog:
    name: live-dyalog (optional)
    runs-on: ubuntu-latest
    needs:
      - critical-gate
      - extension-package
    if: ${{ vars.DYALOG_RIDE_ADDR != '' }}
    env:
      DYALOG_RIDE_ADDR: ${{ vars.DYALOG_RIDE_ADDR }}
      DYALOG_RIDE_LAUNCH: ${{ vars.DYALOG_RIDE_LAUNCH }}
      DYALOG_RIDE_CONNECT_TIMEOUT: ${{ vars.DYALOG_RIDE_CONNECT_TIMEOUT }}
      DYALOG_BIN: ${{ vars.DYALOG_BIN }}
      DYALOG_LIVE_REQUIRE: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"
      - name: Run live harness smoke (when endpoint is configured)
        run: |
          go test ./internal/integration/harness -run '^TestLiveDyalog_' -count=1 -v
          go test ./cmd/dap-adapter -run '^TestLiveDAPAdapter_' -count=1 -v
