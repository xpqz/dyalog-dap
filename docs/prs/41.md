# PR Description - Issue #41

Issue: #41 - Add runtime lifecycle hardening for launched interpreter ownership  
Branch: codex/41-harden-runtime-lifecycle-ownership-and-clean-shutdown  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 3, 7, and 10)

## Summary

This change hardens adapter runtime lifecycle behavior around process ownership and shutdown:

- fixes a real disconnect shutdown hang when the RIDE socket remains open
- introduces explicit ownership policy for `launch` vs `attach`
- adds bounded shutdown waits with component-specific timeout diagnostics
- adds regression tests for stuck-session teardown and ownership policy rules

## Why this change

Issue #41 requires stronger lifecycle correctness and teardown reliability.  
Before this PR, `rideRuntime.stop()` could deadlock by waiting for dispatcher goroutines before closing the underlying harness connection. In practice this could leave sessions stuck and increase zombie/orphan risk when interpreter-side behavior is non-cooperative.

## Scope of changes

Files changed:

- `/Users/stefan/work/lsp-dap/cmd/dap-adapter/main.go`
- `/Users/stefan/work/lsp-dap/cmd/dap-adapter/main_test.go`
- `/Users/stefan/work/lsp-dap/README.md`

### `cmd/dap-adapter/main.go`

Runtime lifecycle changes:

- `rideRuntime.start` now receives request kind (`launch`/`attach`) to enforce ownership semantics at config build time.
- `rideRuntime.stop` teardown order changed to close harness resources before waiting on goroutine completion, preventing read-loop deadlock on open sockets.
- added bounded wait helper (`waitForDone`) and timeout diagnostics:
  - `timeout waiting for RIDE dispatcher shutdown ...`
  - `timeout waiting for DAP bridge shutdown ...`
- aggregates shutdown errors using `errors.Join` instead of silently stalling.

Ownership policy changes (`runtimeConfigFrom`):

- `launch`: may use launch settings (`rideLaunchCommand`, `rideLaunch`, `dyalogBin`) and own interpreter lifecycle.
- `attach`: connect-only mode; environment launch command inheritance is cleared.
- `attach` with explicit launch settings now fails fast with actionable error.

### `cmd/dap-adapter/main_test.go`

Added regression tests:

- `TestRun_DisconnectDoesNotHangWhenRideConnectionStaysOpen`
  - reproduces previous shutdown hang pattern (RIDE connection remains open)
  - verifies adapter returns from `disconnect` without stalling
- `TestRuntimeConfigFrom_AttachClearsEnvLaunchCommand`
  - verifies attach mode does not inherit environment-owned launch command
- `TestRuntimeConfigFrom_AttachRejectsExplicitLaunchSettings`
  - verifies fast failure when attach is misconfigured with launch ownership settings

### `README.md`

Documented lifecycle policy explicitly:

- separated shared args vs `launch`-only args
- documented `attach` as connect-only
- added troubleshooting entry for attach+launch-setting misconfiguration

## Validation performed

Commands run:

- `go test ./cmd/dap-adapter -run '^(TestRun_DisconnectDoesNotHangWhenRideConnectionStaysOpen|TestRuntimeConfigFrom_AttachClearsEnvLaunchCommand|TestRuntimeConfigFrom_AttachRejectsExplicitLaunchSettings)$' -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior changes:

- `attach` is now strict connect-only mode (no adapter-owned interpreter launch).
- disconnect/terminate teardown is more resilient against open-connection hangs.

Risk assessment:

- low to moderate; behavior is intentionally stricter and better aligned with explicit ownership semantics.

Potential migration note:

- users who previously supplied launch options with `attach` must switch to `launch` request type.

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/cmd/dap-adapter/main.go`
2. `/Users/stefan/work/lsp-dap/cmd/dap-adapter/main_test.go`
3. `/Users/stefan/work/lsp-dap/README.md`
