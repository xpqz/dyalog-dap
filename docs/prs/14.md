# PR Description - Issue #14

Issue: #14 - Build source-to-window token registry and lifecycle tracking  
Branch: codex/14-build-source-to-window-token-registry-and-lifecycle-tracking  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 4 and 9)

## Summary

This change adds a source/window registry in the DAP adapter that maintains mappings between DAP source references and RIDE window tokens, with lifecycle updates on `OpenWindow`, `UpdateWindow`, and `CloseWindow`.

## Why this change

Upcoming breakpoint/source workflows require stable source references and accurate token resolution for currently-open windows. This PR establishes that mapping and keeps it synchronized with inbound RIDE lifecycle events.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/dap/adapter/server.go
- /Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go

Implemented in `server.go`:

- source registry state:
  - token -> source binding
  - sourceRef -> active token
  - path -> sourceRef (stable sourceRef reuse)
  - sourceRef -> path
- lookup APIs:
  - `ResolveSourceReferenceForToken(token)`
  - `ResolveTokenForSourceReference(sourceRef)`
- lifecycle handling:
  - `OpenWindow`: binds token to source path, creates/reuses sourceRef
  - `UpdateWindow`: rebinds token if path changes
  - `CloseWindow`: removes token bindings and tracer state
- consistency behavior:
  - rebind to same path+new token removes stale token mapping
  - sourceRef is reused across close/reopen for same path
- tracer cleanup integration:
  - closing a token removes tracer window entry/order to prevent stale stack frames

## Test coverage

Extended `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go` with:

- `TestHandleRidePayload_OpenWindowRegistersSourceReferenceAndToken`
- `TestHandleRidePayload_CloseWindowRemovesTokenMapping`
- `TestHandleRidePayload_ReopenSameSourceReusesSourceReference`
- `TestHandleRidePayload_UpdateWindowRebindsTokenToNewSource`
- `TestHandleRidePayload_RebindingPathToNewTokenUnbindsOldToken`

These tests validate mapping creation, updates, cleanup, sourceRef stability, and stale-token eviction.

## Validation performed

Commands run:

- `go test ./...`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- registry maps one active token per source reference (latest binding wins)
- source references remain stable per path across window reopen

Known limitations in this PR:

- no path normalization strategy yet (assumes canonical paths from RIDE)
- no multi-token-per-source fanout model (deferred unless needed)

## Out of scope

Not part of this PR:

- setBreakpoints translation/wiring
- source loading/content requests by sourceReference

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
