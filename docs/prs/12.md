# PR Description - Issue #12

Issue: #12 - Implement DAP stackTrace using tracer token model  
Branch: codex/12-implement-dap-stacktrace-using-tracer-token-model  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 5 and 9)

## Summary

This change implements DAP `stackTrace` using the tracer-window token model and optional SI-stack enrichment from `ReplyGetSIStack`.

## Why this change

The plan requires stack frames to be modeled from tracer window tokens, with SI stack data as optional enrichment. This PR establishes that frame-construction pipeline and ties it to inbound RIDE lifecycle data already tracked by the adapter.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/dap/adapter/server.go
- /Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go

Implemented in `server.go`:

- DAP stack models:
  - `StackFrame`
  - `StackTraceResponseBody`
- `stackTrace` request handling:
  - lifecycle guard (`launch/attach` required)
  - required `threadId` argument handling
  - frame construction from tracer windows/tokens
- tracer-window frame metadata tracking:
  - frame name from window name
  - line/column from highlight/current position
  - order based on tracer token lifecycle (top frame first)
- optional SI enrichment:
  - caches `ReplyGetSIStack` descriptions by thread
  - overlays frame names from SI descriptions when available
- inbound RIDE handling updates:
  - handles `ReplyGetSIStack`
  - extends tracer state updates from `OpenWindow` and `SetHighlightLine`

## Test coverage

Extended `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go` with:

- `TestHandleRequest_StackTraceBuildsFramesFromTracerWindows`
- `TestHandleRequest_StackTraceUsesReplyGetSIStackDescriptions`
- `TestHandleRequest_StackTraceWithoutThreadIDFails`

These tests verify token-based frame construction, ordering, line/column normalization, SI enrichment behavior, and request preconditions.

## Validation performed

Commands run:

- `go test ./...`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- stackTrace now follows token-window model as primary source
- SI data is additive and optional

Known limitations in this PR:

- source path mapping for frames is not yet implemented
- SI-to-frame mapping currently overlays by positional order

## Out of scope

Not part of this PR:

- source registry integration for stack frames
- variable scopes/evaluate requests

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
