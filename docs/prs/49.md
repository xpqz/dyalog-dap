# PR Description - Issue #49

Issue: #49 - Add extension contract tests for adapter launch and config mapping  
Branch: codex/49-add-extension-contract-tests-for-adapter-launch-and-config-mapping  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (adapter mapping and reliability context)  
Context references: /Users/stefan/work/lsp-dap/README.md, parent epic #43

## Summary

This change adds contract-level extension tests for debug configuration resolution and adapter launch mapping, including env propagation and platform-specific path fallback behavior.

It also introduces explicit CI gating for those contract tests.

## Why this change

Issue #49 targets regression prevention around extension behavior that directly impacts debug startup. Prior tests validated helper functions, but not full launch/config mapping contracts.

This implementation establishes stable contracts and makes CI enforce them.

## Scope of changes

Files changed:

- `/Users/stefan/work/lsp-dap/scaffold_test.go`
- `/Users/stefan/work/lsp-dap/.github/workflows/ci.yml`
- `/Users/stefan/work/lsp-dap/vscode-extension/package.json`
- `/Users/stefan/work/lsp-dap/vscode-extension/src/contracts.ts`
- `/Users/stefan/work/lsp-dap/vscode-extension/src/test/contracts.test.ts`
- `/Users/stefan/work/lsp-dap/vscode-extension/src/adapterPath.ts`
- `/Users/stefan/work/lsp-dap/vscode-extension/src/test/adapterPath.test.ts`
- `/Users/stefan/work/lsp-dap/vscode-extension/src/extension.ts`
- `/Users/stefan/work/lsp-dap/vscode-extension/out/contracts.js`
- `/Users/stefan/work/lsp-dap/vscode-extension/out/adapterPath.js`
- `/Users/stefan/work/lsp-dap/vscode-extension/out/extension.js`
- `/Users/stefan/work/lsp-dap/vscode-extension/README.md`
- `/Users/stefan/work/lsp-dap/README.md`

### New contract module

Added `src/contracts.ts`:

- `resolveDebugConfigurationContract`
- `buildAdapterLaunchContract`

These functions define and centralize:

- empty/default config expansion
- missing field backfill
- adapter path resolution behavior
- argument mapping (`adapterArgs`)
- env propagation (`adapterEnv`, `DYALOG_RIDE_ADDR`)
- actionable adapter resolution error contract

### Extension wiring to contract layer

`src/extension.ts` now uses contract functions directly in:

- debug configuration provider
- adapter descriptor factory

This keeps runtime behavior aligned with tested contracts and removes duplicated mapping logic.

### Platform fallback coverage

`resolveAdapterPath` now accepts an optional `platform` override (defaulting to runtime platform), enabling deterministic tests for both Windows and Unix executable naming.

### Contract tests

Added `src/test/contracts.test.ts` covering:

- default launch config mapping for empty input
- partial config backfill behavior
- launch/attach mapping semantics for args/env propagation
- `DYALOG_RIDE_ADDR` preservation when already set
- actionable missing-adapter error path

Extended `src/test/adapterPath.test.ts` for platform-specific fallback assertions.

### CI enforcement

Added `test:contracts` npm script and updated CI extension package job to run:

- `npm run test:contracts`

before full extension test/build steps.

Scaffold tests now enforce:

- presence of `test:contracts`
- contract test file existence
- CI invocation of `npm run test:contracts`

## Validation performed

Commands run:

- `go test ./... -count=1`
- `go vet ./...`
- `cd /Users/stefan/work/lsp-dap/vscode-extension && npm run lint && npm run test:contracts && npm run test && npm run build`
- `cd /Users/stefan/work/lsp-dap/vscode-extension && npm run package:vsix`

Result:

- all checks pass
- contract tests are green locally and explicitly wired into CI

## Compatibility and risk

Behavioral impact:

- runtime mapping behavior remains consistent but is now centralized and tested
- missing adapter errors remain actionable with setup command guidance

Risk:

- low; mostly test/structure hardening plus explicit CI gate

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/vscode-extension/src/contracts.ts`
2. `/Users/stefan/work/lsp-dap/vscode-extension/src/test/contracts.test.ts`
3. `/Users/stefan/work/lsp-dap/vscode-extension/src/extension.ts`
4. `/Users/stefan/work/lsp-dap/.github/workflows/ci.yml`
5. `/Users/stefan/work/lsp-dap/scaffold_test.go`
