# PR Description - Issue #51

Issue: #51 - Expand evaluate semantics for watch, hover, and repl contexts  
Branch: codex/51-expand-evaluate-semantics-for-watch-hover-and-repl-contexts  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (evaluate/value-tip mapping)  
Context references: /Users/stefan/work/lsp-dap/README.md, parent epic #44

## Summary

This change formalizes a context-specific evaluate behavior matrix (`watch`, `hover`, `repl`), improves timeout/error translation, and adds a deterministic fallback path for `repl` when ValueTip is insufficient.

The fallback uses cached symbol values from the practical locals model introduced in issue #50.

## Why this change

Issue #51 called out incomplete evaluate semantics and weak failure behavior for non-watch contexts.

This implementation makes evaluate behavior explicit, deterministic, and test-covered per context.

## Scope of changes

Files changed:

- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
- `/Users/stefan/work/lsp-dap/README.md`

### Evaluate context behavior matrix

Implemented normalized context handling:

- `watch`: ValueTip-only, requires ready prompt and frame context
- `hover`: same semantics as watch
- `repl`:
  - uses ValueTip path when frame context exists
  - falls back to cached symbol value when ValueTip send/timeout is insufficient
  - returns clear error when neither frame nor cached symbol can satisfy evaluation

### Alternative path when ValueTip is insufficient

Added cached symbol fallback for `repl`:

- resolves simple symbol expressions from frame symbol cache
- returns typed evaluate response (`nameclass(n)`) without blocking/hanging
- also used when ValueTip send/timeout fails in repl context

### Timeout and error translation improvements

- Added configurable server `evaluateTimeout` state (defaults to existing global timeout)
- Added context-specific timeout messages (`watch`/`hover`/`repl`)
- Updated unsupported-context and busy-prompt messages to be explicit/actionable

### Tests

Added context-specific evaluate tests:

- hover success path using ValueTip
- repl cached fallback behavior
- watch timeout actionable error message

Existing evaluate watch and busy-prompt tests remain green.

## Validation performed

Commands run:

- `go test ./internal/dap/adapter -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all checks pass

## Compatibility and risk

Behavioral impact:

- evaluate semantics are now deterministic per context and documented
- repl context can now succeed via cached fallback where ValueTip is unavailable

Risk:

- low; primarily behavior-hardening and messaging updates with focused tests

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go` (new evaluate context tests)
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go` (`handleEvaluateRequest` and helper functions)
3. `/Users/stefan/work/lsp-dap/README.md` (context matrix documentation)
