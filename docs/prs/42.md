# PR Description - Issue #42

Issue: #42 - Implement DAP evaluate and source requests  
Branch: codex/42-implement-dap-evaluate-and-source-requests  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 8, 9, and open evaluate/repl questions)

## Summary

This change adds phase-appropriate DAP `evaluate` and `source` handling to the adapter:

- `evaluate` for watch/repl/hover contexts using RIDE `GetValueTip`/`ValueTip` correlation
- `source` content retrieval by `sourceReference` (mapped from RIDE windows) or fallback path read
- prompt-state busy gating for evaluate (`SetPromptType` integration)
- regression tests for payload decoding, prompt gating, and source mapping/error paths

## Why this change

Issue #42 requires moving beyond control-flow-only debugging so clients can inspect values and retrieve source text through DAP-native requests.  
The adapter already had source mapping and event processing primitives; this PR wires those into concrete request handlers.

## Scope of changes

Files changed:

- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
- `/Users/stefan/work/lsp-dap/README.md`

### `internal/dap/adapter/server.go`

Added DAP response models:

- `EvaluateResponseBody`
- `SourceResponseBody`

Added request handlers:

- `evaluate`:
  - validates session state/controller/context/expression
  - rejects evaluate while prompt is busy (`SetPromptType type=0`)
  - sends `GetValueTip` with generated correlation token
  - waits (bounded timeout) for matching `ValueTip`
  - translates tip payload into DAP evaluate response
- `source`:
  - resolves by `sourceReference` or `source.path`
  - serves in-memory source text captured from RIDE `OpenWindow`/`UpdateWindow`
  - falls back to filesystem read when mapped text is unavailable

Added event/state handling:

- captures `SetPromptType` to track busy/ready prompt state
- captures `ValueTip` payload and dispatches to pending evaluate waiters
- captures source text arrays from `OpenWindow`/`UpdateWindow` for `source` responses

Server capability update:

- `supportsEvaluateForHovers` now `true`

### `internal/dap/adapter/server_test.go`

Added focused regression tests:

- `TestHandleRequest_EvaluateWatchUsesValueTipAndReturnsDecodedResult`
  - covers payload decoding of `ValueTip.tip` from `[]any`
  - validates command mapping and evaluate response translation
- `TestHandleRequest_EvaluateFailsWhenPromptBusy`
  - verifies prompt-state gating and no outbound evaluate send while busy
- `TestHandleRequest_SourceReturnsMappedWindowText`
  - verifies `sourceReference` -> mapped content retrieval
- `TestHandleRequest_SourceWithoutMappingFails`
  - verifies error translation for unmapped source requests

### `README.md`

Updated capability status to include:

- `scopes`, `variables`, `source`, `evaluate` in phase-1 command list
- architecture summary note about evaluate/source support path

## Validation performed

Commands run:

- `go test ./internal/dap/adapter -run '^(TestHandleRequest_EvaluateWatchUsesValueTipAndReturnsDecodedResult|TestHandleRequest_EvaluateFailsWhenPromptBusy|TestHandleRequest_SourceReturnsMappedWindowText|TestHandleRequest_SourceWithoutMappingFails)$' -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior changes:

- adapter now responds to DAP `evaluate` and `source`
- evaluate currently uses ValueTip correlation and requires an active tracer window/frame context

Known limitation:

- full REPL execution-evaluate semantics (multi-output execute pipeline) remain future work

Risk assessment:

- moderate; new request paths are isolated to adapter state machine and bounded by timeout/error guards

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
3. `/Users/stefan/work/lsp-dap/README.md`
