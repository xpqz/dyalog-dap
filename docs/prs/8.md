# PR Description - Issue #8

Issue: #8 - Implement DAP server bootstrap and capability negotiation  
Branch: codex/8-implement-dap-server-bootstrap-and-capability-negotiation  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (section 9)

## Summary

This change adds a concrete DAP bootstrap lifecycle skeleton in Go with phase-1 capability negotiation. The adapter now has a typed request/response/event model and an explicit state machine for core lifecycle commands.

## Why this change

The project needs a stable DAP control-plane entry point before wiring runtime debugger actions. This PR establishes the initialize/launch-or-attach/configurationDone/disconnect flow and a clearly defined initial capability set aligned with the phase-1 scope.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/dap/adapter/server.go
- /Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go

Implemented in `server.go`:

- typed minimal DAP envelopes:
  - `Request`
  - `Response`
  - `Event`
- capability model:
  - `Capabilities` (returned directly as `initialize` response body)
- explicit server lifecycle state machine:
  - `created`
  - `initialized`
  - `attachedOrLaunched`
  - `terminated`
- request handler:
  - `HandleRequest` handling
    - `initialize`
    - `launch`
    - `attach`
    - `configurationDone`
    - `disconnect`
    - `terminate`
  - unsupported command rejection
  - invalid lifecycle transition rejection
  - `initialized` event emission after successful `initialize`

Phase-1 capabilities currently advertised:

- `supportsConfigurationDoneRequest: true`
- `supportsTerminateRequest: true`
- all advanced capabilities false for now (step-back, conditional breakpoints, setVariable, etc.)

## Test coverage

Added `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go` with:

- `TestHandleRequest_InitializeReturnsCapabilitiesAndInitializedEvent`
- `TestHandleRequest_InitializeTwiceFails`
- `TestHandleRequest_LaunchRequiresInitialize`
- `TestHandleRequest_ConfigurationDoneRequiresLaunchOrAttach`
- `TestHandleRequest_DisconnectTerminatesSession`
- `TestHandleRequest_UnsupportedCommandFails`

These tests lock both capability negotiation behavior and lifecycle transition constraints.

## Validation performed

Commands run:

- `go test ./...`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- this is an in-process lifecycle skeleton, not full DAP wire-protocol I/O yet
- unknown commands return `success=false` with a message

Known limitations in this PR:

- no stdio/socket protocol framing for DAP messages yet
- no runtime RIDE integration for execution/stepping/threads in this issue

## Out of scope

Not part of this PR:

- continue/next/step/pause mapping
- threads/stackTrace handlers
- breakpoint translation

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
