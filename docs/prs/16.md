# PR Description - Issue #16

Issue: #16 - Enforce SaveChanges -> ReplySaveChanges -> CloseWindow ordering  
Branch: codex/16-enforce-savechanges-replysavechanges-closewindow-ordering  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 4 and 10)

## Summary

This change adds pending-save tracking in the RIDE session dispatcher so `CloseWindow` is deferred until a matching `ReplySaveChanges` is received, enforcing the required ordering for safe save/close flows.

## Why this change

The plan identifies `SaveChanges -> ReplySaveChanges -> CloseWindow` as a critical protocol ordering rule. Sending `CloseWindow` too early risks discarding pending save state and diverging from RIDE behavior.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/ride/sessionstate/dispatcher.go
- /Users/stefan/work/lsp-dap/internal/ride/sessionstate/dispatcher_test.go

Implemented in `dispatcher.go`:

- Added pending-save and deferred-close state:
  - `pendingSaves map[int]int`
  - `pendingCloses map[int][]outboundCommand`
- Updated `SendCommand` behavior:
  - tracks in-flight `SaveChanges` by window id
  - defers `CloseWindow` when a save is pending for the same window
  - rolls back pending-save state when `SaveChanges` write fails
- Added `ReplySaveChanges` inbound handling:
  - decrements pending-save counters
  - flushes deferred `CloseWindow` commands once the save is acknowledged
- Added shared window-id extraction helpers for `WindowArgs`, `SaveChangesArgs`, `ReplySaveChangesArgs`, and map payloads.

## Test coverage

Extended `/Users/stefan/work/lsp-dap/internal/ride/sessionstate/dispatcher_test.go` with:

- `TestDispatcher_CloseWindowWaitsForReplySaveChanges`
- `TestDispatcher_CloseWindowWithoutPendingSaveWritesImmediately`
- `TestDispatcher_SaveChangesWriteFailureDoesNotBlockCloseWindow`

These tests verify the ordered close behavior, preserve non-pending-close behavior, and guard the save-write-failure edge case.

## Validation performed

Commands run:

- `gofmt -w internal/ride/sessionstate/dispatcher.go internal/ride/sessionstate/dispatcher_test.go`
- `go test ./internal/ride/sessionstate -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- Close commands are now serialized behind save acknowledgements per window.
- Multiple in-flight saves per window are reference-counted before close release.

Known limitations in this PR:

- Deferred close retry on transport write error is retained in memory and will require a future successful trigger path to flush.

## Out of scope

Not part of this PR:

- window-layout restore/reconnect workflows
- adapter-level source/breakpoint rehydration
- live Dyalog integration validation for save/close sequencing

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/ride/sessionstate/dispatcher_test.go`
2. `/Users/stefan/work/lsp-dap/internal/ride/sessionstate/dispatcher.go`
