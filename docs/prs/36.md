# PR Description - Issue #36

Issue: #36 - Harden harness shutdown to avoid orphaned Dyalog processes  
Branch: codex/36-harden-harness-shutdown-orphaned-dyalog  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 10, 11)

## Summary

This change hardens integration harness process lifecycle management to prevent orphaned Dyalog processes after test/runtime shutdown.

The harness now uses process-group-aware termination on Unix (gritt-style) with timeout-based escalation:

- launch command is started in its own process group
- shutdown sends a group `SIGTERM` first
- if the process group does not exit quickly, shutdown escalates to group `SIGKILL`
- `Wait()` is always consumed so process state is reaped cleanly

Windows behavior remains safe/fallback by using process kill semantics without Unix process-group signals.

## Why this change

Dyalog processes can persist when only the parent shell is terminated, especially when launch commands involve shell-managed children/background jobs. That can leave orphan/zombie interpreters and pollute subsequent runs.

`reference/gritt` handles this by isolating process groups and killing the full group on cleanup. This PR applies the same principle in harness lifecycle management.

## Scope of changes

Files changed:

- `/Users/stefan/work/lsp-dap/internal/integration/harness/harness.go`
- `/Users/stefan/work/lsp-dap/internal/integration/harness/process_tree_unix.go`
- `/Users/stefan/work/lsp-dap/internal/integration/harness/process_tree_windows.go`
- `/Users/stefan/work/lsp-dap/internal/integration/harness/harness_process_unix_test.go`

### `harness.go`

Updated launch/stop flow:

- `startLaunchCommand` now delegates process-group setup to platform helper (`setLaunchProcessGroup`)
- `stopLaunchCommand` now:
  - runs `Wait()` in a goroutine
  - sends group terminate signal first
  - waits up to `launchStopTimeout`
  - escalates to force-kill if needed
  - normalizes expected exit errors from intentional teardown

### `process_tree_unix.go`

Unix-specific process tree helpers:

- `setLaunchProcessGroup` with `SysProcAttr{Setpgid: true}`
- `terminateProcessTree` via negative-pid `SIGTERM`
- `killProcessTree` via negative-pid `SIGKILL`

### `process_tree_windows.go`

Windows-specific fallback helpers:

- no-op process-group setup
- terminate/kill mapped to `Process.Kill()`

### `harness_process_unix_test.go`

New Unix regression test:

- `TestHarness_CloseTerminatesSpawnedBackgroundChild`
  - starts launch command that creates a background child and waits
  - captures child PID
  - closes harness
  - asserts child PID is no longer alive

This specifically protects against orphaned background child leakage.

## Test coverage

Added explicit regression coverage for process cleanup behavior under shell/background-child launch patterns (Unix).

## Validation performed

Commands run:

- `go test ./internal/integration/harness -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior changes:

- launch teardown is now process-group-aware on Unix and more aggressive against leaked children
- shutdown timing includes bounded wait + escalation path

Risk:

- launch commands that intentionally keep unrelated long-running siblings in the same process group will now be terminated on harness close; this is expected for harness-managed launch lifecycle and aligns with cleanup safety goals.

## Out of scope

Not included in this PR:

- PID namespace/cgroup isolation beyond process-group management
- interpreter-level graceful `)off` sequencing (this is transport/lifecycle cleanup only)

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/integration/harness/harness.go`
2. `/Users/stefan/work/lsp-dap/internal/integration/harness/process_tree_unix.go`
3. `/Users/stefan/work/lsp-dap/internal/integration/harness/harness_process_unix_test.go`
4. `/Users/stefan/work/lsp-dap/internal/integration/harness/process_tree_windows.go`
