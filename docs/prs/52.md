# PR Description - Issue #52

Issue: #52 - Harden source lifecycle consistency across window/mapping changes  
Branch: codex/52-harden-source-lifecycle-consistency-across-window-mapping-changes  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (source/token mapping behavior)  
Context references: /Users/stefan/work/lsp-dap/README.md, parent epic #44

## Summary

This change hardens DAP source retrieval semantics under window churn and mapping updates by enforcing explicit precedence and invalidation rules.

Authoritative behavior is now:

- Active mapped window: in-memory window text is authoritative.
- Closed/unmapped source: disk content is authoritative.
- Missing disk content after invalidation: fail with path-rich diagnostics.

## Why this change

Issue #52 identified stale/cross-bound source risks during `CloseWindow`, path rebinding, and token/sourceReference churn.

This implementation ensures source content remains coherent and avoids stale in-memory bleed-through once mappings are inactive.

## Scope of changes

Files changed:

- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
- `/Users/stefan/work/lsp-dap/README.md`

### Source precedence and mapping safety

`handleSourceRequest` now resolves content with explicit precedence:

1. If path is currently active/mapped to a live token, return in-memory window text.
2. Otherwise read from disk.
3. If disk read fails, return failure including path + underlying error detail.

### Lifecycle invalidation

Added path activity checks and cache invalidation in mapping lifecycle:

- On `CloseWindow`, remove in-memory text for path when no active token remains.
- On token rebinding to a different path, invalidate old path in-memory text when no active token remains.

This prevents stale window text from being returned for inactive source references.

### Tests added

Added source lifecycle tests for:

- active window text precedence over disk
- close-window invalidation and disk fallback
- update-window path churn avoiding cross-bound old-reference content
- source failure diagnostics including resolved path

## Validation performed

Commands run:

- `go test ./internal/dap/adapter -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all checks pass

## Compatibility and risk

Behavioral impact:

- source responses for inactive mappings now intentionally avoid stale in-memory cache.
- failures now include richer path diagnostics for supportability.

Risk:

- low; behavior is more deterministic and covered by lifecycle-focused tests.

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go` (new source lifecycle tests)
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go` (`handleSourceRequest`, mapping invalidation helpers)
3. `/Users/stefan/work/lsp-dap/README.md` (precedence documentation)
