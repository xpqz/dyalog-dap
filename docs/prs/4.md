# PR Description - Issue #4

Issue: #4 - Implement typed RIDE command codec with tolerant unknown handling
Branch: codex/4-implement-typed-ride-command-codec-with-tolerant-unknown-handling
Commit: e30c8f9
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md

## Summary

This PR implements a typed RIDE message codec in Go with tolerant decode behavior and numeric/boolean normalization helpers.

The main goal is to provide a safe protocol boundary that:

- encodes outgoing command payloads as JSON command tuples
- decodes known JSON command payloads into structured data
- gracefully tolerates unknown commands and malformed/non-JSON payloads by preserving raw input
- normalizes protocol boolean-like values where the interpreter can use either booleans or numeric 0/1

## Why this change

The project plan requires that transport and protocol handling be resilient to asynchronous and evolving command streams. Real RIDE traffic includes both JSON command arrays and non-JSON handshake payloads, and unknown commands must not crash the adapter pipeline.

This PR establishes that contract in one place, with tests that lock behavior before higher-level state machine work continues.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/ride/protocol/codec.go
- /Users/stefan/work/lsp-dap/internal/ride/protocol/codec_test.go

Implemented in `codec.go`:

- `PayloadKind` enum with:
  - `KindRaw`
  - `KindCommand`
- `DecodedPayload` struct with:
  - `Kind`
  - `Raw`
  - `Command`
  - `Args`
  - `Known`
- `Codec` now tracks a known-command registry seeded with phase-1/near-term protocol commands.
- `EncodeCommand(command, args)`:
  - emits payload as JSON `[
    command,
    args
  ]`
  - defaults `args` to empty map when nil
- `DecodePayload(payload)`:
  - returns `KindRaw` for non-JSON payloads (e.g. handshake lines)
  - returns `KindRaw` for malformed JSON command payloads
  - returns `KindCommand` for valid command arrays
  - marks `Known=false` when command name is unrecognized
- `NormalizeBool(v any) (bool, bool)`:
  - supports `bool` and numeric 0/1 forms (`int*`, `uint*`, `float32`, `float64`)
  - returns `(false, false)` when input is unsupported

## Test coverage

Added test file:

- /Users/stefan/work/lsp-dap/internal/ride/protocol/codec_test.go

Tests included:

- `TestEncodeCommand_EncodesCommandArray`
- `TestDecodePayload_KnownCommand`
- `TestDecodePayload_UnknownCommandIsTolerated`
- `TestDecodePayload_NonJSONIsRaw`
- `TestDecodePayload_BadJSONFallsBackToRaw`
- `TestNormalizeBool_SupportsBoolAndNumericFlags`

These tests enforce tolerant decode behavior, command typing, and normalization semantics expected by the plan.

## Validation performed

Command run:

- `go test ./...`

Result:

- all tests pass

## Compatibility and risk

Behavioral compatibility notes:

- Unknown or malformed payloads are intentionally not fatal at the codec layer.
- This keeps protocol parsing robust as command surface area grows.

Known limitations in this PR:

- Known-command registry is currently static in code.
- No strict schema validation of command argument shapes yet; this is deliberate for incremental integration.

## Out of scope

Not part of this PR:

- transport read/write framing changes
- session-state dispatch integration
- DAP request/event mapping

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/ride/protocol/codec_test.go` to confirm expected behavior contracts.
2. `/Users/stefan/work/lsp-dap/internal/ride/protocol/codec.go` to verify implementation matches tests and plan requirements.
3. sanity-check known command list and decide whether to keep static list here or move to shared command metadata in a later PR.

## Follow-up expected

Next logical work after merge:

- issue #5 (single-reader dispatcher and prompt-aware outbound scheduling)
- wire codec outputs into transport/session-state pipeline
