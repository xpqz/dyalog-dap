# PR Description - Issue #4

Issue: #4 - Implement typed RIDE command codec with tolerant unknown handling
Branch: codex/4-implement-typed-ride-command-codec-with-tolerant-unknown-handling
Commits:
- e30c8f9
- follow-up commit addressing crev review (typed command models)
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md

## Summary

This PR implements a typed RIDE message codec in Go with tolerant decode behavior and numeric/boolean normalization helpers.
It was updated after review to ensure known phase-1 commands decode into typed argument models rather than generic maps.

The main goal is to provide a safe protocol boundary that:

- encodes outgoing command payloads as JSON command tuples
- decodes known JSON command payloads into structured data
- gracefully tolerates unknown commands and malformed/non-JSON payloads by preserving raw input
- normalizes protocol boolean-like values where the interpreter can use either booleans or numeric 0/1

## Why this change

The project plan requires that transport and protocol handling be resilient to asynchronous and evolving command streams. Real RIDE traffic includes both JSON command arrays and non-JSON handshake payloads, and unknown commands must not crash the adapter pipeline.

This PR establishes that contract in one place, with tests that lock behavior before higher-level state machine work continues.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/ride/protocol/codec.go
- /Users/stefan/work/lsp-dap/internal/ride/protocol/codec_test.go

Implemented in `codec.go`:

- `PayloadKind` enum with:
  - `KindRaw`
  - `KindCommand`
- `DecodedPayload` struct with:
  - `Kind`
  - `Raw`
  - `Command`
  - `Args` (typed `any`; known commands decode to typed structs)
  - `Known`
- Typed argument models for phase-1 command subset and related control/debug commands, including:
  - `ExecuteArgs`
  - `IdentifyArgs`
  - `ConnectArgs`
  - `SetPromptTypeArgs`
  - `AppendSessionOutputArgs`
  - `WindowContentArgs`
  - `WindowArgs`
  - `SetLineAttributesArgs`
  - `SetHighlightLineArgs`
  - `WindowTypeChangedArgs`
  - `SaveChangesArgs`
  - `ReplySaveChangesArgs`
  - `GetThreadsArgs`
  - `ReplyGetThreadsArgs`
  - `SetThreadArgs`
  - `GetSIStackArgs`
  - `ReplyGetSIStackArgs`
  - `HadErrorArgs`
  - `DisconnectArgs`
  - `SysErrorArgs`
  - `UnknownCommandArgs`
  - `InternalErrorArgs`
- `Codec` tracks:
  - known-command registry
  - command-specific typed decoders
- `EncodeCommand(command, args)`:
  - now accepts `args any`
  - emits payload as JSON `["Command",{...}]`
  - defaults to empty map when `args` is nil
- `DecodePayload(payload)`:
  - returns `KindRaw` for non-JSON payloads (e.g. handshake lines)
  - returns `KindRaw` for malformed JSON command payloads
  - returns `KindCommand` for valid command arrays
  - decodes known commands into typed arg structs
  - preserves tolerant fallback (`map[string]any`) for unknown commands
  - marks `Known=false` when command name is unrecognized
- `NormalizeBool(v any) (bool, bool)`:
  - supports `bool` and numeric 0/1 forms (`int*`, `uint*`, `float32`, `float64`)
  - returns `(false, false)` when input is unsupported

## Test coverage

Added test file:

- /Users/stefan/work/lsp-dap/internal/ride/protocol/codec_test.go

Tests included:

- `TestEncodeCommand_EncodesCommandArray`
- `TestDecodePayload_KnownCommand_DecodesTypedArgs`
- `TestDecodePayload_OpenWindow_DecodesTypedArgsAndNormalizesBoolFlags`
- `TestDecodePayload_UnknownCommandIsTolerated`
- `TestDecodePayload_NonJSONIsRaw`
- `TestDecodePayload_BadJSONFallsBackToRaw`
- `TestNormalizeBool_SupportsBoolAndNumericFlags`

These tests enforce tolerant decode behavior, command typing, and normalization semantics expected by the plan.

## Validation performed

Command run:

- `go test ./...`

Result:

- all tests pass

## Compatibility and risk

Behavioral compatibility notes:

- Unknown or malformed payloads are intentionally not fatal at the codec layer.
- This keeps protocol parsing robust as command surface area grows.

Known limitations in this PR:

- Known-command registry is currently static in code.
- Unknown commands intentionally decode into generic maps.
- Malformed command JSON is intentionally downgraded to `KindRaw` (non-fatal) to keep protocol handling tolerant.

## Out of scope

Not part of this PR:

- transport read/write framing changes
- session-state dispatch integration
- DAP request/event mapping

## Review Follow-up

crev identified a major gap: typed models were not actually used in decode output.

Addressed by:

- changing `DecodedPayload.Args` to `any`
- adding command-specific typed decoder functions
- decoding known phase-1 commands to typed structs
- extending tests to assert typed decode behavior directly

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/ride/protocol/codec_test.go` to confirm expected behavior contracts.
2. `/Users/stefan/work/lsp-dap/internal/ride/protocol/codec.go` to verify implementation matches tests and plan requirements.
3. sanity-check known command list and decide whether to keep static list here or move to shared command metadata in a later PR.

## Follow-up expected

Next logical work after merge:

- issue #5 (single-reader dispatcher and prompt-aware outbound scheduling)
- wire codec outputs into transport/session-state pipeline
