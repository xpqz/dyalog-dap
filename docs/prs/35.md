# PR Description - Issue #35

Issue: #35 - Wire cmd/dap-adapter into long-running stdio DAP server  
Branch: codex/35-wire-stdio-dap-server  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 2, 4, 5, 9, 10)

## Summary

This change replaces the scaffold-only `/cmd/dap-adapter` entrypoint with a real long-running stdio DAP process loop.

It now:

- reads and writes DAP messages over stdio using `Content-Length` framing
- dispatches DAP requests into `internal/dap/adapter.Server`
- writes DAP responses and events with adapter-managed sequence numbers
- starts a real RIDE runtime on `launch`/`attach` (connect/launch via harness config)
- bridges inbound RIDE events into adapter `HandleRidePayload` and emits resulting DAP events
- shuts down cleanly on `disconnect`/`terminate`

## Why this change

The project had complete adapter/runtime logic in-process but `/cmd/dap-adapter` only constructed a server and exited immediately. This blocked real VS Code debugger interaction over the DAP wire protocol.

## Scope of changes

Files changed:

- `/Users/stefan/work/lsp-dap/cmd/dap-adapter/main.go`
- `/Users/stefan/work/lsp-dap/cmd/dap-adapter/main_test.go`
- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`

### `cmd/dap-adapter/main.go`

Implemented:

- `run(context.Context, io.Reader, io.Writer, io.Writer) error`
  - main stdio loop
  - DAP request decoding and routing
  - DAP response/event encoding and emission
- DAP framing helpers:
  - `readDAPPayload`
  - `writeDAPPayload`
- request/response/event wire envelope types for stdio protocol messages
- synchronized writer with outbound sequence tracking (`dapWriter`)
- runtime wiring layer (`rideRuntime`)
  - starts harness + session dispatcher on `launch`/`attach`
  - sets adapter `RideCommandSender` to dispatcher
  - bridges dispatcher event stream to adapter `HandleRidePayload`
  - emits generated adapter events to DAP client
  - graceful runtime stop and transport teardown
- launch/attach runtime config extraction:
  - from request args and env (`DYALOG_RIDE_*`)
  - supports override keys:
    - `rideAddr`
    - `rideLaunchCommand`
    - `rideTranscriptsDir`
    - `rideConnectTimeout`
    - `rideConnectTimeoutMs`
    - `dyalogBin` (converted to `RIDE_INIT=SERVE:*:<port> ... +s -q`)

### `cmd/dap-adapter/main_test.go`

Added end-to-end stdio protocol tests:

- `TestRun_InitializeAndDisconnectOverStdio`
  - validates DAP framing loop, initialize response, initialized event, disconnect shutdown
- `TestRun_LaunchAndControlRoundTripAgainstRide`
  - starts fake RIDE server
  - verifies full startup handshake and startup commands
  - drives DAP requests over stdio:
    - `initialize`
    - `launch`
    - `threads` (poll path)
    - `stackTrace`
    - `next`
    - `setBreakpoints`
    - `disconnect`
  - asserts mapped outbound RIDE commands:
    - `GetThreads`
    - `RunCurrentLine`
    - `SetLineAttributes` with translated stop lines
  - validates end-to-end request/response success over DAP wire framing
- `TestRun_LaunchBeforeInitializeDoesNotStartRideRuntime`
  - verifies launch precondition handling remains DAP-correct
  - asserts no RIDE dial side effects occur before successful `initialize`

### `internal/dap/adapter/server.go`

Added:

- `CanLaunchOrAttach() bool` guard used by the command entrypoint to prevent premature runtime startup before adapter initialization.

## Test coverage

This PR adds command-entrypoint-level wire tests (stdio + RIDE fake server) which were previously missing.

Coverage focus:

- DAP wire framing correctness at process boundary
- adapter request dispatch over real stdio envelopes
- runtime startup and ride controller binding on launch
- control/breakpoint command mapping continuity through the command binary

## Validation performed

Commands run:

- `go test ./cmd/dap-adapter -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior changes:

- `cmd/dap-adapter` is now a persistent stdio server process rather than a no-op scaffold
- launch/attach now attempts RIDE runtime startup and returns actionable error responses on configuration/runtime failures

Risks:

- asynchronous RIDE event bridge writes currently best-effort for event emission failures (request path remains strict/fail-fast)
- launch argument schema for RIDE config is intentionally minimal and may need expansion as VS Code integration matures

## Out of scope

Not included in this issue:

- full VS Code extension packaging/config for end users
- richer DAP features beyond current phase-1 command set
- multi-session/multi-interpreter process management

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/cmd/dap-adapter/main.go`
2. `/Users/stefan/work/lsp-dap/cmd/dap-adapter/main_test.go`
3. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
