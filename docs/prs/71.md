# PR Description - Issue #71

Issue: #71 - Introduce outbound intent pattern and remove I/O-under-lock in migrated adapter paths  
Branch: codex/71-outbound-intent-pattern-no-io-under-lock-migrated-paths  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/refactor.md (Phase 3: lock/I-O boundary clarity)  
Context references: /Users/stefan/work/lsp-dap/docs/plans/refactor.md, parent phase #67, parent epic #64

## Summary

This change introduces an explicit outbound command intent model for deferred-breakpoint application flows and moves those RIDE sends to execute after releasing the adapter state lock.

## Why this change

Issue #71 targets lock/I-O boundary clarity and reduces deadlock/latency risk by avoiding controller sends while holding `Server.mu` in migrated paths.

## Scope of changes

Files changed:

- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_intents_test.go`

### Outbound intent pattern

- added `outboundCommandIntent` representation with explicit `kind`, `command`, args, and deferred-breakpoint metadata
- `HandleRidePayload` now accumulates intents while locked and executes them in a deferred post-unlock phase

### Migrated paths

- `OpenWindow` and `UpdateWindow` deferred breakpoint apply flow now creates intent under lock
- `SetLineAttributes` send for deferred apply now runs outside lock via `executeOutboundIntents`
- pending deferred breakpoint maps are cleared only on successful intent execution, preserving prior semantics

### Regression coverage

- added `TestHandleRidePayload_OpenWindowDeferredApplyExecutesSendOutsideLock`
- test validates that `SendCommand` callback can re-enter lock-taking server path without deadlock

## Validation performed

Commands run:

- `go test ./internal/dap/adapter -run 'DeferredApplyExecutesSendOutsideLock|OpenWindowAppliesDeferredBreakpoints|UpdateWindowAppliesDeferredBreakpointsWithConsistentLineTranslation' -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all checks pass

## Compatibility and risk

Behavioral impact:

- no intended behavioral changes to deferred breakpoint semantics; success/failure output events are preserved

Risk:

- low-to-moderate. Intent execution ordering is now explicit; migration is currently scoped to deferred-breakpoint apply paths.

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_intents_test.go`
