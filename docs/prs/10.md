# PR Description - Issue #10

Issue: #10 - Emit DAP stopped events from tracer lifecycle transitions  
Branch: codex/10-emit-dap-stopped-events-from-tracer-lifecycle-transitions  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 4 and 9)

## Summary

This change adds inbound RIDE lifecycle handling in the adapter server and emits DAP `stopped` events from tracer-related transitions.

Implemented stop-signal mapping:

- `OpenWindow` (debugger tracer window) -> DAP `stopped` with reason `entry`
- `SetHighlightLine` -> DAP `stopped` with reason `step`
- `HadError` -> DAP `stopped` with reason `exception`

## Why this change

Phase-1 DAP debugging requires stop notifications tied to tracer lifecycle. This PR adds the first stop-event synthesis layer and keeps active window/thread selection synchronized with inbound RIDE signals.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/dap/adapter/server.go
- /Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go

Implemented in `server.go`:

- runtime tracer state tracking:
  - active tracer window id
  - active thread id
  - tracer window -> thread mapping
- new event body model:
  - `StoppedEventBody`
- inbound RIDE handler:
  - `HandleRidePayload(protocol.DecodedPayload) []Event`
- argument extraction helpers for relevant RIDE commands:
  - `OpenWindow`
  - `SetHighlightLine`
  - `SetThread`
  - `HadError`
- thread selection logic:
  - prioritizes explicitly active thread (`SetThread`)
  - falls back to active tracer windowâ€™s thread mapping

Also integrated with existing control mapping by updating active tracer window state via inbound tracer events.

## Test coverage

Extended `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go` with:

- `TestHandleRidePayload_OpenWindowDebuggerEmitsStoppedAndUpdatesActiveWindow`
- `TestHandleRidePayload_SetHighlightLineEmitsStepStoppedAndSelectsThread`
- `TestHandleRidePayload_HadErrorEmitsExceptionStopped`
- `TestHandleRidePayload_OpenWindowNonDebuggerDoesNotEmitStopped`

These tests validate stopped reason mapping plus active window/thread selection behavior.

## Validation performed

Commands run:

- `go test ./...`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- stop events are synthesized from RIDE lifecycle events without requiring full stackTrace/thread endpoints yet
- active tracer window now updates from inbound tracer signals and is reused by DAP control command mapping

Known limitations in this PR:

- stopped events currently use minimal reason/thread payload only
- detailed exception metadata and stack frame reason enrichment are deferred

## Out of scope

Not part of this PR:

- DAP threads request implementation
- DAP stackTrace response wiring
- full stopped-event reason taxonomy beyond current phase-1 mapping

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
