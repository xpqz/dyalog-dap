# PR Description - Issue #50

Issue: #50 - Implement practical locals and variable inspection model  
Branch: codex/50-implement-practical-locals-and-variable-inspection-model  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (DAP variables/scopes mapping strategy)  
Context references: /Users/stefan/work/lsp-dap/README.md, parent epic #44

## Summary

This change upgrades DAP `scopes`/`variables` from frame-metadata-only output to a practical symbol inspection model backed by RIDE `GetValueTip`.

The adapter now:

- extracts visible symbols from tracer source (`locals` + inferred globals),
- fetches values through `GetValueTip`,
- exposes category variables (`locals`, `globals`) for expansion,
- supports large-value truncation with paginated child entries,
- preserves stable scope references across repeated refreshes for a stopped frame.

## Why this change

Issue #50 identified that current variable inspection was not useful for real debugging because it surfaced mostly frame metadata.

This implementation provides actionable locals/global values while preserving existing metadata context.

## Scope of changes

Files changed:

- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
- `/Users/stefan/work/lsp-dap/README.md`

### Locals/global symbol model

Added server-side symbol state per tracer frame:

- parsed visible symbol set from source text
- local/global classification
- cached ValueTip value/class state
- pending ValueTip token tracking

`scopes` now triggers symbol refresh and bounded ValueTip fetches before building the scope object.

### Variable categories and expansion

Frame variables now include category objects:

- `locals` -> expandable children for local symbols
- `globals` -> expandable children for non-local visible symbols (when present)

Existing frame metadata variables (`line`, `column`, `thread`, `source`, `siStack`, etc.) remain present.

For symbol values:

- scalar preview is truncated to a configured rune limit
- multiline/long values get child pagination entries (`[0]`, `[1]`, â€¦)
- child list is capped with overflow indicator (`[...] <n> more entries`)

### Stability and lifecycle behavior

- `scopes` variable references remain stable across repeated refresh for unchanged symbol sets
- frame-specific symbol/pending-tip state is cleaned up on frame unbind/reconnect/terminate

### Tests

Added/updated adapter tests for:

- locals/globals category population via ValueTip-backed symbol values
- long-value expansion, truncation, and pagination caps
- stable scope reference behavior across repeated `scopes` calls

Existing scope/metadata tests remain green to preserve previously implemented behavior.

## Validation performed

Commands run:

- `go test ./internal/dap/adapter -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all checks pass

## Compatibility and risk

Behavioral impact:

- `variables` output now includes practical symbol categories/values in addition to metadata.
- first scopes request may include bounded ValueTip fetch latency (short timeout) to improve value availability.

Risk:

- moderate-low: adds stateful symbol/value caching and asynchronous ValueTip coordination; covered by focused adapter tests.

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go` (`handleScopesRequest`, symbol extraction/value-tip flow)
3. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go` (value truncation/pagination helpers)
