# PR Description - Issue #19

Issue: #19 - Implement robust handling for Disconnect/SysError/InternalError/UnknownCommand  
Branch: codex/19-implement-robust-handling-for-disconnect-syserror-internalerror-unknowncommand  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 3 and 7)

## Summary

This change adds adapter-side handling for RIDE session/error commands by translating them into DAP output/termination events and applying controlled session teardown where appropriate.

## Why this change

The adapter previously ignored several critical RIDE runtime diagnostics. This left teardown/recovery behavior undefined and could keep the DAP session alive after fatal interpreter-side failures.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/dap/adapter/server.go
- /Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go

Implemented in `server.go`:

- Added DAP output event model:
  - `OutputEventBody`
- Added RIDE payload handling in `HandleRidePayload` for:
  - `Disconnect`: emit stderr output + terminated event, mark session terminated
  - `SysError`: emit stderr output + terminated event, mark session terminated
  - `InternalError`: emit stderr output + terminated event, mark session terminated
  - `UnknownCommand`: emit console output, keep session alive
- Added helper logic for:
  - controlled session teardown (`terminateSessionFromRide`)
  - normalized output event creation (`newOutputEvent`, newline handling)
  - message formatting for each command type
  - typed argument extraction for Disconnect/SysError/InternalError/UnknownCommand

## Test coverage

Extended `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go` with:

- `TestHandleRidePayload_DisconnectEmitsTerminatedAndEndsSession`
- `TestHandleRidePayload_SysErrorEmitsTerminatedAndEndsSession`
- `TestHandleRidePayload_InternalErrorEmitsTerminatedAndEndsSession`
- `TestHandleRidePayload_UnknownCommandEmitsOutputWithoutTermination`

These tests verify event translation and post-condition state behavior (terminated vs active).

## Validation performed

Commands run:

- `gofmt -w internal/dap/adapter/server.go internal/dap/adapter/server_test.go`
- `go test ./internal/dap/adapter -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- fatal RIDE diagnostics now drive explicit adapter termination semantics
- unknown-command diagnostics are surfaced without forcing teardown

Known limitations in this PR:

- output translation currently uses synthesized text formatting rather than preserving raw payload structure
- no reconnection path is introduced here; this PR focuses on deterministic teardown/reporting

## Out of scope

Not part of this PR:

- automated reconnect/state restoration
- richer DAP exception metadata mapping for InternalError/SysError
- protocol-level retry policies

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
