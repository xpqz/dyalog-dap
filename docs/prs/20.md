# PR Description - Issue #20

Issue: #20 - Implement reconnect flow with GetWindowLayout-based restoration  
Branch: codex/20-implement-reconnect-flow-with-getwindowlayout-based-restoration  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 2 and 7)

## Summary

This change introduces an explicit adapter reconnect hook that restores an active session after transport recovery by resetting transient runtime state and requesting `GetWindowLayout` so source/token/thread state can be rebuilt from subsequent RIDE lifecycle events.

## Why this change

After disconnect, the adapter could terminate with stale runtime caches and no controlled recovery path. Reconnect support needs deterministic lifecycle handling and state rebuild initiation.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/dap/adapter/server.go
- /Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go

Implemented in `server.go`:

- Added reconnect lifecycle hook:
  - `HandleRideReconnect() []Event`
- Reconnect behavior:
  - transitions server back to attached/launched state (unless never initialized)
  - clears transient runtime state (`active*`, tracer/thread caches, token bindings)
  - preserves stable source-reference path registry
  - requests `GetWindowLayout` to trigger layout-based state restoration
  - emits an informational DAP output event for reconnect visibility
- Added internal state reset helper:
  - `resetRuntimeStateForReconnect()`

## Test coverage

Extended `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go` with:

- `TestHandleRideReconnect_RequestsLayoutAndResetsActiveState`
- `TestHandleRideReconnect_RebuildsSourceMappingFromLayoutEvents`

These tests verify post-disconnect recovery, layout sync signaling, runtime-state reset, and source mapping rebuild from reopened windows.

## Validation performed

Commands run:

- `gofmt -w internal/dap/adapter/server.go internal/dap/adapter/server_test.go`
- `go test ./internal/dap/adapter -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- reconnect now follows a controlled recovery path rather than leaving session state terminal/stale
- active tracer/thread selection is intentionally reset to avoid acting on stale tokens

Known limitations in this PR:

- reconnect trigger wiring is hook-based; integration with transport reconnection orchestration is still required by higher-level runtime flow
- restored state depends on receiving `OpenWindow`/`UpdateWindow` events after `GetWindowLayout`

## Out of scope

Not part of this PR:

- automatic transport-level reconnect retries/backoff
- pending-command replay across reconnect
- UI-level reconnect policy/configuration

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
