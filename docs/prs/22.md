# PR Description - Issue #22

Issue: #22 - Implement busy-state outbound allow-list/queue policy  
Branch: codex/22-implement-busy-state-outbound-allow-list-queue-policy  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (section 3)

## Summary

This change completes busy-state queue semantics in the session dispatcher by adding cancellation/clear rules on key inbound error signals while preserving the existing promptType=0 allow-list behavior.

## Why this change

The dispatcher already deferred non-allow-listed commands while busy, but queue-cancel behavior for runtime errors and disconnect paths was not enforced. That could flush stale commands after error/fatal transitions.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/ride/sessionstate/dispatcher.go
- /Users/stefan/work/lsp-dap/internal/ride/sessionstate/dispatcher_test.go

Implemented in `dispatcher.go`:

- inbound command classification additions in `handleInbound`:
  - `HadError`: cancel queued `Execute` commands
  - `Disconnect` / `SysError` / `InternalError`: clear deferred outbound state
- added helper methods:
  - `cancelQueuedExecutes()`
  - `clearDeferredSends()`
- preserved existing allow-list and prompt transition flush semantics.

## Test coverage

Extended `/Users/stefan/work/lsp-dap/internal/ride/sessionstate/dispatcher_test.go` with:

- `TestDispatcher_HadErrorCancelsQueuedExecuteCommands`
- `TestDispatcher_DisconnectClearsQueuedCommands`

These tests validate queue-cancel behavior for busy-state deferred sends under recoverable and fatal signal paths.

## Validation performed

Commands run:

- `gofmt -w internal/ride/sessionstate/dispatcher.go internal/ride/sessionstate/dispatcher_test.go`
- `go test ./internal/ride/sessionstate -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- busy deferred `Execute` commands no longer flush after `HadError`
- fatal session signals now drop queued/deferred outbound work to avoid replaying stale commands

Known limitations in this PR:

- command-priority/partial replay strategy is intentionally not introduced; queue handling is conservative to prioritize correctness

## Out of scope

Not part of this PR:

- reconnect replay policy for deferred commands
- adapter-level user-facing diagnostics for each canceled queued command

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/ride/sessionstate/dispatcher_test.go`
2. `/Users/stefan/work/lsp-dap/internal/ride/sessionstate/dispatcher.go`
