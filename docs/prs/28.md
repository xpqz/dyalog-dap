# PR Description - Issue #28

Issue: #28 - Add integration tests for breakpoint persistence and save-close ordering  
Branch: codex/28-add-integration-tests-for-breakpoint-persistence-and-save-close-ordering  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (section 4)

## Summary

This change adds integration coverage for two ordering-critical behaviors:

- `setBreakpoints` translation to outbound `SetLineAttributes`
- `SaveChanges -> ReplySaveChanges -> CloseWindow` sequencing on the wire

Both scenarios run through harness-based protocol integration with fake RIDE server flows.

## Why this change

These are core protocol correctness paths identified as ordering sensitive in the plan. Existing unit tests covered components independently; this adds composed runtime assertions.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/integration/harness/harness_test.go

Implemented tests:

- `TestIntegration_SetBreakpointsSendsSetLineAttributes`
  - validates adapter+dispatcher mapping from DAP breakpoints to RIDE `SetLineAttributes`
  - asserts correct target `win` and 0-based `stop` line array
- `TestIntegration_SaveReplyCloseOrdering`
  - validates `CloseWindow` is not sent before `ReplySaveChanges`
  - asserts `SaveChanges` first, no premature close, then `CloseWindow` after reply

Added helper:

- `decodeCommandStop` for outbound stop-array assertions.

## Test coverage

Integration harness now directly verifies breakpoint and save/close ordering behavior at protocol boundary, not only as unit-level state transitions.

## Validation performed

Commands run:

- `gofmt -w internal/integration/harness/harness_test.go`
- `go test ./internal/integration/harness -count=1 -run 'TestIntegration_SetBreakpointsSendsSetLineAttributes|TestIntegration_SaveReplyCloseOrdering' -v -timeout 30s`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- breakpoint translation and save/close ordering are now covered in composed integration tests

Known limitations in this PR:

- scenarios are fake-server based and do not yet cover live interpreter persistence semantics across process restarts

## Out of scope

Not part of this PR:

- live Dyalog breakpoint persistence across reconnect/restart
- UI-level end-to-end debugger verification

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/integration/harness/harness_test.go`
