# PR Description - Issue #11

Issue: #11 - Implement DAP threads request backed by GetThreads  
Branch: codex/11-implement-dap-threads-request-backed-by-getthreads  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 5 and 9)

## Summary

This change implements DAP `threads` request handling backed by RIDE `GetThreads`, with adapter-side cache updates from `ReplyGetThreads` and stable DAP thread IDs.

## Why this change

The plan requires thread data flow from RIDE into DAP with stable IDs and a polling/subscription strategy. This PR adds both:

- polling trigger: every DAP `threads` request sends RIDE `GetThreads`
- subscription/caching path: inbound `ReplyGetThreads` updates adapter thread cache

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/dap/adapter/server.go
- /Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go

Implemented in `server.go`:

- DAP thread models:
  - `Thread`
  - `ThreadsResponseBody`
- server thread cache state:
  - cached threads by id
  - stable ordered snapshot of last `ReplyGetThreads`
  - synthetic id registry for non-positive/unknown RIDE thread ids
- `threads` request handling:
  - lifecycle guard (`launch/attach` required)
  - RIDE controller guard
  - sends `GetThreads`
  - returns current cached snapshot
- inbound RIDE handling:
  - `HandleRidePayload` now processes `ReplyGetThreads`
  - updates cache via `updateThreadCache`
- argument extraction helper:
  - `extractReplyGetThreads`

## Test coverage

Extended `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go` with:

- `TestHandleRequest_ThreadsPollsGetThreadsAndReturnsCachedThreads`
- `TestHandleRidePayload_ReplyGetThreadsMaintainsStableIDsAcrossUpdates`
- `TestHandleRequest_ThreadsWithoutRideControllerFails`

These tests validate polling behavior, cache hydration, stable IDs across updates, and controller precondition handling.

## Validation performed

Commands run:

- `go test ./...`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- `threads` currently returns last cached snapshot immediately after issuing `GetThreads`
- cache refresh is asynchronous via subsequent `ReplyGetThreads` payloads

Known limitations in this PR:

- no explicit timeout/wait path for first poll response
- synthetic ID strategy for malformed/non-positive tids is best-effort and internal

## Out of scope

Not part of this PR:

- stackTrace endpoint wiring
- thread attributes/pause-all integration

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
