# PR Description - Issue #40

Issue: #40 - Implement DAP scopes and variables requests  
Branch: codex/40-implement-dap-scopes-and-variables-requests  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 5 and 9)

## Summary

This change adds first-class `scopes` and `variables` handling to the Go DAP adapter, backed by active tracer-frame state from RIDE events.

The implementation introduces:

- `scopes` request support for active stack frames (`frameId` based)
- `variables` request support with stable `variablesReference` handles
- hierarchical variable expansion that covers scalar, object, and array inspection behaviors
- request/state validation and error handling for missing/invalid references

## Why this change

Issue #40 requires DAP-side variable inspection primitives to move from stack-only debugging to frame context inspection.  
The existing adapter already tracks thread/frame/window state from RIDE; this PR exposes that state through DAP `scopes`/`variables` APIs in a stable, testable form.

## Scope of changes

Files changed:

- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
- `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`

### `internal/dap/adapter/server.go`

Added DAP models:

- `Scope`, `ScopesResponseBody`
- `Variable`, `VariablesResponseBody`

Added server state for variable-handle management:

- `frameScopeRef map[int]int`
- `variablesByRef map[int][]Variable`
- `nextVariablesRef int`

Added request handling:

- `scopes` command:
  - validates launch/attach state
  - validates `frameId`
  - validates frame exists in active tracer state
  - returns a `Locals` scope with stable `variablesReference`
- `variables` command:
  - validates launch/attach state
  - validates `variablesReference`
  - returns variables for known references, fails for unknown references

Added hierarchical variable graph builder for frame context:

- top-level scope variables include frame/thread/source/stack metadata
- object expansion via child references (`thread`, `source`)
- array expansion via child references (`siStack`)
- scalar variables for direct values (`line`, `column`, `threadName`, etc.)

Added lifecycle cleanup/reset:

- variable references tied to frame scopes are dropped on window close (`CloseWindow` path)
- reconnect reset clears scope/variable caches to avoid stale handles

### `internal/dap/adapter/server_test.go`

Added TDD coverage for new behavior:

- `TestHandleRequest_ScopesRequiresFrameID`
- `TestHandleRequest_ScopesAndVariablesExposeFrameContext`
- `TestHandleRequest_VariablesUnknownReferenceFails`

These assert:

- required argument validation
- stable scope `variablesReference` for repeated `scopes` calls
- scalar/object/array variable expansion behavior
- unknown `variablesReference` error path

## Validation performed

Commands run:

- `go test ./internal/dap/adapter -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior changes:

- Adapter now advertises and responds to DAP `scopes` and `variables` requests during active sessions.

Known limitations in this phase:

- variable payload currently surfaces frame-context metadata/state rather than full interpreter symbol-table enumeration
- deeper expression evaluation/object member expansion remains future work (tracked separately)

Risk assessment:

- low to moderate; changes are isolated to adapter request handling and covered by unit/integration suite

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
3. `/Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md` sections 5 and 9 (traceability)
