# PR Description - Issue #17

Issue: #17 - Handle breakpoints when target source is not yet open  
Branch: codex/17-handle-breakpoints-when-target-source-is-not-yet-open  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 9 and 10)

## Summary

This change adds deferred breakpoint handling for unmapped sources. When `setBreakpoints` targets a file/sourceReference with no active RIDE window token, the adapter now stores pending breakpoints, requests `GetWindowLayout`, and applies those breakpoints automatically when the source is later opened or updated.

## Why this change

The RIDE debugger model is window-token centric while DAP breakpoints are file centric. Without deferral, breakpoints set before a file window exists are dropped. This issue closes that gap and introduces on-demand sync behavior.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/dap/adapter/server.go
- /Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go

Implemented in `server.go`:

- Added deferred breakpoint state:
  - `pendingByPath map[string][]int`
  - `pendingBySourceRef map[int][]int`
- Updated `setBreakpoints` behavior for unmapped sources:
  - stores deferred lines keyed by path/sourceReference
  - triggers `GetWindowLayout` request for on-demand source/window synchronization
  - returns unverified breakpoints (existing response semantics)
- Updated source lifecycle handling (`OpenWindow`/`UpdateWindow`):
  - attempts deferred breakpoint application via `SetLineAttributes` when a mapped token becomes available
  - clears deferred entries after successful apply
- Added helper methods for deferred state management and sync requests.

## Test coverage

Extended `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go` with:

- updated `TestHandleRequest_SetBreakpointsUnverifiedWhenSourceNotMapped` to assert `GetWindowLayout` sync request
- `TestHandleRidePayload_OpenWindowAppliesDeferredBreakpoints`
- `TestHandleRequest_SetBreakpointsUnmappedReplacesDeferredLines`
- `TestHandleRidePayload_ReopenSourceAppliesDeferredBySourceReference`

These tests validate deferred storage, sync signaling, late apply on open, replacement semantics, and sourceReference-based deferred apply.

## Validation performed

Commands run:

- `gofmt -w internal/dap/adapter/server.go internal/dap/adapter/server_test.go`
- `go test ./internal/dap/adapter -count=1`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- unmapped `setBreakpoints` no longer drops user intent; it is deferred until mapping exists
- each unmapped request triggers a `GetWindowLayout` sync request
- latest deferred breakpoint set replaces prior deferred set for the same source identity

Known limitations in this PR:

- deferred breakpoint application currently depends on subsequent `OpenWindow`/`UpdateWindow` events
- failed deferred `SetLineAttributes` sends are retained for future retry opportunities only via later lifecycle events

## Out of scope

Not part of this PR:

- breakpoint persistence across process reconnect/restart
- DAP `breakpoint` events for late verification transitions
- function/conditional/hit-count breakpoint support

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server_test.go`
2. `/Users/stefan/work/lsp-dap/internal/dap/adapter/server.go`
