# PR Description - Issue #27

Issue: #27 - Add integration tests for tracer lifecycle and stepping controls  
Branch: codex/27-add-integration-tests-for-tracer-lifecycle-and-stepping-controls  
Plan reference: /Users/stefan/work/lsp-dap/docs/plans/ride-protocol.md (sections 4 and 9)

## Summary

This change adds an end-to-end integration test for tracer lifecycle and step control routing (`OpenWindow`, `SetHighlightLine`, `CloseWindow`, and DAP step/continue behavior) using the harness + dispatcher + adapter stack with a fake RIDE server.

While adding this test, it exposed a real transport deadlock risk in full-duplex read/write concurrency, which is fixed in the same PR.

## Why this change

The roadmap calls for integration validation of debugger lifecycle and stepping behavior. Existing tests covered units, but not the composed runtime path from wire payloads through dispatcher into adapter command mapping.

## Scope of changes

Files changed:

- /Users/stefan/work/lsp-dap/internal/integration/harness/harness_test.go
- /Users/stefan/work/lsp-dap/internal/ride/transport/client.go

Implemented in `harness_test.go`:

- added `TestIntegration_TracerLifecycleAndSteppingControls` that validates:
  - inbound `OpenWindow` + `SetHighlightLine` drives active tracer selection
  - DAP `next` maps to outbound `RunCurrentLine` with correct `win`
  - inbound `CloseWindow` clears active tracer path and causes subsequent `continue` to fail
- added payload helper `decodeCommandWin` for outbound `win` assertions.

Implemented in `client.go`:

- fixed full-duplex locking behavior by separating read/write synchronization:
  - switched state lock to `sync.RWMutex`
  - introduced `readMu` and `writeMu` to avoid read/write mutex contention deadlock
  - now snapshots conn/reader/logger under `RLock`, performs blocking I/O outside state lock

## Test coverage

New integration test exercises composed behavior across:

- transport framing
- dispatcher event loop
- adapter lifecycle and stepping command mapping

It also prevents regression of the discovered read/write lock contention issue.

## Validation performed

Commands run:

- `gofmt -w internal/integration/harness/harness_test.go internal/ride/transport/client.go`
- `go test ./internal/integration/harness -count=1 -run TestIntegration_TracerLifecycleAndSteppingControls -v -timeout 30s`
- `go test ./... -count=1`
- `go vet ./...`

Result:

- all tests pass
- vet clean

## Compatibility and risk

Behavior notes:

- tracer lifecycle + step routing is now integration-tested
- transport client now supports concurrent read/write without deadlock from shared lock contention

Known limitations in this PR:

- integration flow remains fake-server based and does not yet include live Dyalog matrix execution

## Out of scope

Not part of this PR:

- live interpreter stepping behavior verification across versions
- DAP UI-level debugger harness assertions

## Reviewer guide

Suggested review order:

1. `/Users/stefan/work/lsp-dap/internal/integration/harness/harness_test.go`
2. `/Users/stefan/work/lsp-dap/internal/ride/transport/client.go`
